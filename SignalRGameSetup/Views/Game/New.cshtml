@using SignalRGameSetup.Models.Setup
@model NewGameViewModel

@{ ViewBag.Title = "New"; }

<!-- Figure out why the chat isn't updating for a second player (especially in a diff browser)-->

<link rel="stylesheet" href="~/Content/chat.css" />
<link rel="stylesheet" href="~/Content/game.css" />
<link rel="stylesheet" href="~/Content/board.css" />
<link rel="stylesheet" href="~/Content/ship.css" />


<h2>New</h2>

@ViewBag.GameCode
<br />
@ViewBag.ParticipantId


<div id="mainDiv">


    <div id="gameArea">


        <div id="boardDiv">

            <div id="enemyBoard" class="halfBoard">

            </div>

            <div id="playerBoard" class="halfBoard">

            </div>

        </div>


    </div>



    <div id="chatArea" class="game-room-chat">

        <div id="chatContent">

            <div id="chatMessages"></div>

            <div id="addMessage">
                <input type="text" id="messageInput" placeholder="Enter message here"
                       onkeypress="checkIfEnterPressed(event)" />
                <input type="button" id="addMessageBtn" value="Add" />
            </div>

        </div>

    </div>

</div>



@section Scripts {
    @*<script src="~/Scripts/jquery.signalR-2.4.2.min.js"></script>*@
    <script src="~/signalr/hubs"></script>
    <script type="text/javascript">

                        @*document.getElementById('chatMessages').innerHTML = @Model.Chat.ChatHtml;*@

        var clientName; // this should be accessible to any needed javascript file
        var clientId = '@Model.ParticipantId';
        var gameSetup;


        var gameInformation; // this should be set on page load by the game hub - it should contain ship info too


        // Start up the hub connection for setup
        jQuery(document).ready(function ($) {
            setupHub = $.connection.setupHub;
            gameHub = $.connection.gameHub;
            chat = $.connection.chatHub;

            // game hub
            

            // setup hub

            setupHub.client.setClientInfo = function (participant) {
                clientName = participant.Name;
                clientId = participant.ParticipantId;
            };

            setupHub.client.updateGameSetup = function (setup) {
                console.log('updating setup');
                gameSetup = setup;
            }

            setupHub.client.connectTheChat = function () {
                chat.server.connectToGame({
                    gameCode: '@Model.GameCode',
                    ParticipantId: '@Model.ParticipantId'
                });
            }

            // chat hub

            // add participant to chat group
            chat.client.addNewMessage = function (newMessage) {
                console.log('adding message');
                addChatMessage(newMessage.Name, newMessage.Message);
            };

            // load the chat
            chat.client.loadTheChat = function (gameChat) {
                console.log('chat loaded');
                console.log(gameChat);
                showChatHtml(gameChat.ChatHtml, gameChat.DoSaveAfterShow);

                // TODO once chat is loaded, set the game information
            }

            chat.client.updateGameSetup = function (setup) {
                console.log('updating setup');
                gameSetup = setup;
            }

            // start connection
            $.connection.hub.start().done(function () {
                console.log('starting');

                // set the game up
                setupHub.server.connectToGame({
                    gameCode: '@Model.GameCode',
                    ParticipantId: '@Model.ParticipantId'
                });

                console.log('connecting chat');
                chat.server.connectToGame({
                    gameCode: '@Model.GameCode',
                    ParticipantId: '@Model.ParticipantId'
                });
            });

        });

    </script>
}







<script src="~/Scripts/chat.js"></script>
<script src="~/Scripts/game.js"></script>
<script src="~/Scripts/board-setup.js"></script>